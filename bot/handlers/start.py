import loguru
from aiogram import Router, types
from aiogram.fsm.context import FSMContext
from aiogram.filters import CommandStart, Command, CommandObject
from asgiref.sync import sync_to_async
from django.core.exceptions import ObjectDoesNotExist
from django.db.transaction import atomic

from .fio import DoctorState
from schemas.patient import PatientCreateSchema
from keyboards.reply import get_reply_keyboard, reply_cancel_keyboard
from orm.patient import get_or_create_patient_and_update_protocol
from web.protocols.models import Protocol
from web.patients.models import Patient
from web.doctors.models import Doctor

router = Router()


@router.message(CommandStart())
async def start_command_handler(
    message: types.Message,
    command: CommandObject,
    state: FSMContext,
):
    message_text = (
        f'–ü—Ä–∏–≤–µ—Ç, {message.from_user.first_name}.'
    )
     
    try:
        doctor = await Doctor.objects.aget(telegram_id=message.from_user.id)
        await message.answer(
            '–í—ã —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã. –í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ.',
            reply_markup=get_reply_keyboard(
                buttons=('–ú–µ–Ω—é üìÅ', '–°—Ç–∞—Ä—Ç –Ω–æ–≤–æ–≥–æ –ø—Ä–æ—Ç–æ–∫–æ–ª–∞ üìù')
            )
        )
        return
        
    except ObjectDoesNotExist:
        pass
       
    if not command.args:
        message_text += '\n–û—Ç–ø—Ä–∞–≤—å —Å–≤–æ–µ –§–ò–û –æ–¥–Ω–∏–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º'
        
        await message.answer(
            message_text, 
            reply_markup=reply_cancel_keyboard
        )
        await state.set_state(DoctorState.fio)
        return
    
    
    protocol_id = command.args
        
    try:
        protocol = await Protocol.objects.aget(id=protocol_id)
    except ObjectDoesNotExist:
        await message.answer('–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π QR-–∫–æ–¥')
        return 
        
    patient_create_schema = PatientCreateSchema(
        telegram_id=message.from_user.id,
        username=message.from_user.username,
        name=protocol.patient_name
    )
    await get_or_create_patient_and_update_protocol(
        protocol, 
        patient_create_schema
    )
        
    await message.answer(
        '–ü—Ä–æ—Ç–æ–∫–æ–ª —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω! –í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ.',
        reply_markup=get_reply_keyboard(buttons=('–ú–µ–Ω—é üìÅ', ))
    )

    
    

